# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1azoOI9FgyVAtXs7Bzho61qYA4uBaDnwP
"""

import streamlit as st
import pandas as pd
import io

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(
    page_title="ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°æ”¯æ´ã‚¢ãƒ—ãƒª",
    page_icon="ğŸ”§",
    layout="wide"
)

# --- é–¢æ•° ---
@st.cache_data # ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
def load_csv(uploaded_file):
    """ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸCSVã‚’DataFrameã¨ã—ã¦èª­ã¿è¾¼ã‚€"""
    try:
        df = pd.read_csv(uploaded_file)
        return df
    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚ ({e})")
        return None

def convert_df_to_csv(df):
    """DataFrameã‚’CSVå½¢å¼ã®ãƒã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã™ã‚‹"""
    return df.to_csv(index=False).encode('utf-8')


# --- ãƒ¡ã‚¤ãƒ³ç”»é¢ ---
st.title("ğŸ”§ ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°æ”¯æ´ã‚¢ãƒ—ãƒª")
st.write("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€GUIã§æ–°ã—ã„ç‰¹å¾´é‡ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ---
st.sidebar.header("æ“ä½œãƒ‘ãƒãƒ«")
uploaded_file = st.sidebar.file_uploader("ã“ã“ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=["csv"])

# --- ã‚¢ãƒ—ãƒªæœ¬ä½“ ---
if uploaded_file is not None:
    df = load_csv(uploaded_file)

    if df is not None:
        st.subheader("ğŸ“Š å…ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ")
        st.dataframe(df.head())

        # --- ç‰¹å¾´é‡ä½œæˆã®é¸æŠè‚¢ ---
        st.sidebar.subheader("ç‰¹å¾´é‡ã‚’ä½œæˆ")

        # å‡¦ç†ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹ãƒªã‚¹ãƒˆ
        generated_code = []

        # 1. FamilySizeã®ä½œæˆ
        if 'sibsp' in df.columns and 'parch' in df.columns:
            if st.sidebar.checkbox("`FamilySize` ã‚’ä½œæˆã™ã‚‹", value=False):
                df['FamilySize'] = df['sibsp'] + df['parch'] + 1
                generated_code.append("df['FamilySize'] = df['sibsp'] + df['parch'] + 1")
        else:
            st.sidebar.warning("`FamilySize`ã®ä½œæˆã«ã¯`sibsp`ã¨`parch`åˆ—ãŒå¿…è¦ã§ã™ã€‚")

        # 2. IsAloneã®ä½œæˆ (FamilySizeãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿)
        if 'FamilySize' in df.columns:
            if st.sidebar.checkbox("`IsAlone` ã‚’ä½œæˆã™ã‚‹", value=False):
                df['IsAlone'] = 0
                df.loc[df['FamilySize'] == 1, 'IsAlone'] = 1
                generated_code.append("df['IsAlone'] = 0\ndf.loc[df['FamilySize'] == 1, 'IsAlone'] = 1")

        # 3. å¹´é½¢ã®ã‚«ãƒ†ã‚´ãƒªåŒ– (ãƒ“ãƒ‹ãƒ³ã‚°)
        if 'age' in df.columns:
            if st.sidebar.checkbox("`AgeGroup` ã‚’ä½œæˆã™ã‚‹", value=False):
                # æ¬ æå€¤ã‚’ä¸­å¤®å€¤ã§è£œå®Œ
                median_age = df['age'].median()
                df['age_filled'] = df['age'].fillna(median_age)

                bins = [0, 12, 18, 35, 60, 100]
                labels = ['Child', 'Teenager', 'Young Adult', 'Adult', 'Senior']
                df['AgeGroup'] = pd.cut(df['age_filled'], bins=bins, labels=labels, right=False)

                # ä¸è¦ã«ãªã£ãŸè£œå®Œåˆ—ã‚’å‰Šé™¤
                df = df.drop(columns=['age_filled'])

                generated_code.append(f"# æ¬ æå€¤ã‚’ä¸­å¤®å€¤({median_age})ã§è£œå®Œ\ndf['age'] = df['age'].fillna({median_age})\n\nbins = [0, 12, 18, 35, 60, 100]\nlabels = ['Child', 'Teenager', 'Young Adult', 'Adult', 'Senior']\ndf['AgeGroup'] = pd.cut(df['age'], bins=bins, labels=labels, right=False)")
        else:
            st.sidebar.warning("`AgeGroup`ã®ä½œæˆã«ã¯`age`åˆ—ãŒå¿…è¦ã§ã™ã€‚")

        st.divider()

        # --- çµæœè¡¨ç¤º ---
        st.subheader("âœ¨ ç‰¹å¾´é‡ä½œæˆå¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ")
        st.dataframe(df.head())

        # --- ã‚³ãƒ¼ãƒ‰è¡¨ç¤º ---
        if generated_code:
            st.subheader("ğŸ ç”Ÿæˆã•ã‚ŒãŸPythonã‚³ãƒ¼ãƒ‰")
            st.info("ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã€ä»Šå›ã®æ“ä½œã‚’å†ç¾ã§ãã¾ã™ã€‚")
            full_code = "\n\n".join(generated_code)
            st.code(full_code, language='python')

        # --- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ ---
        st.download_button(
           label="åŠ å·¥å¾Œã®CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
           data=convert_df_to_csv(df),
           file_name='featured_data.csv',
           mime='text/csv',
        )

else:
    st.info("ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚")
    st.image("https://storage.googleapis.com/s4a-prod-share-staging/2022-09-22T06-03-51.341Z/csv-file.png", width=150)